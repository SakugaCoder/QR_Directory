<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <link rel="stylesheet" href="./css/dashboard.css">
    <link rel="stylesheet" href="./css/edit.css">
    <title>Nueva ficha de mantenimiento</title>
</head>
<body>
    <header>
        <div class="logo-container">
                <img src="assets/logo.png" alt="QR Directory logo">
                <h3>QR Directory</h3>
        </div>
        <div class="btn-container">
            <a class="btn-regresar" href="#" onclick="regresar(event)">Regresar</a>
        </div>
    </header>

    <div class="main-wraper">
        <div class="item-data">
            <form action="" method="POST" onsubmit="createSchedule(event)" id="edit-form">
                    <div class="general-data">    
                        <h2 style="text-align: center; font-weight: normal; font-size: 20px; margin-bottom: 20px;">Nueva ficha tecnica para <b id="item_value"></b></h2>
                        <input type="hidden" name="id" value="noid">

                        <div class="field">
                                <label for="f_inicio">Fecha inicio: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                                <input type="date" name="f_inicio" id="f_inicio" placeholder="Fecha inicio">
                        </div>
                        <br>

                        <div class="field">
                                <label for="f_termino">Fecha termino: &nbsp;&nbsp;&nbsp;&nbsp;</label>
                                <input type="date" name="f_termino" id="f_termino" placeholder="Fecha termino">
                        </div>

                        <div class="field">
                                <label for="n_act">Numero actividades: </label>
                                <input type="number" name="n_act" id="n_act" placeholder="Numero actividades">
                        </div>

                    </div>
    
                    <input type="submit" name="btn_save" id="btn_save" value="Crear">
            </form>
        </div>

        <table id="table_activities" style="display: none;">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Descripci贸n actividad</th>
                        <th>Fecha inicio</th>
                        <th>Fecha termin贸</th>
                    </tr>
                </thead>
    
                <tbody>
                </tbody>
            </table>
    </div>

	<footer>
        <p class="footer-text">2019. QR <b>Directory</b></p>
    </footer>

    <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
    <script type="text/javascript" src="./assets/plugins/jquery.qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script src="./scripts/qrdirectory.js"></script>
    <script src="./scripts/new_support.js"></script>

    <style>
        #table_activities{
            display: block;
            max-width: 700px;
            width: 100%;
            margin: 40px auto;
            box-shadow: 0px 4px 4px rgba(0, 0, 0, 0.25);
            padding: 20px;
        }


        #table_activities tbody tr, #table_activities thead tr{
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-around;
        }
        
        input[type="submit"]{
            font-weight: lighter;
            display: block;
            max-width: 160px;
            width: 100%;
            max-height: 66px;
            height: 100%;
            margin: 0px auto;
            background: none;
            color: #fff;
            border: 2px solid #FFFFFF;
            box-sizing: border-box;
            border-radius: 20px;
            transition: all ease 0.2s;
            padding: 15px 30px;
            box-shadow: 0px 4px 4px rgba(0, 0, 0, 0);
            border-color: #000;
            color: #000;
        }

        input[type="submit"]:hover{
            cursor: pointer;
            background: #9e3549;
            border-color: #9e3549;
            color: #fff;
            box-shadow: 0px 4px 4px rgba(0, 0, 0, 0.25); 
        }

    </style>

    <script>
        let fi = null;
        let ft = null;
        let acn = null;
        function regresar(evt){
            evt.preventDefault();
            window.location.replace('support.html?item='+item);
        }


        function createSchedule(evt){
            evt.preventDefault();
            fi = document.querySelector("#f_inicio").value;
            ft = document.querySelector("#f_termino").value;
            acn = document.querySelector("#n_act").value;

            if(fi.length  > 0 && ft.length > 0 && Number(acn) > 0){    
                let table = document.querySelector("#table_activities tbody");
                table.innerHTML = "";
                console.log("Creating shedule "+acn);

                for(i = 0; i < Number(acn); i++){
                    row =  '<tr><td>'+i+'&nbsp;&nbsp;</td>\
                            <td><textarea  name="des'+i+'" id="des'+i+'" placeholder="Descripci贸n" required></textarea></td>\
                            <td>&nbsp;<input type="date" name="fi'+i+'" id="fi'+i+'" placeholder="Fecha inicio" required>&nbsp;</td>\
                            <td><input type="date" name="ft'+i+'" id="ft'+i+'" placeholder="Fecha termin贸" required>&nbsp;</td></tr>';
                    table.innerHTML+= row;
                }

                table.innerHTML+='<input type="submit" name="btnSaveSupport" value="Guardar" onclick="sendSchedule();">';
                document.querySelector("#table_activities").style.display = "block";
            }

            else{
                alert("Error al crear hoja mantenimiento");
            }
        }

        function sendSchedule(){
            fd_sheet = new FormData();
            fd_sheet.append("new_support_sheet",0);
            fd_sheet.append("material",item);
            fd_sheet.append("fecha_inicio",fi);
            fd_sheet.append("fecha_termino",ft);

            let request_new_sheet = new XMLHttpRequest();
            request_new_sheet.onload = function(){
                console.log("Sending schedule");
                console.log(request_new_sheet.responseText);

                let support_sheet = request_new_sheet.responseText;
                let activities = document.querySelectorAll("#table_activities tbody tr");
                let error = false;
                activities.forEach(function(val,indice){
                    let description = document.querySelector("#des"+indice).value;
                    let fi_act = document.querySelector("#fi"+indice).value;
                    let ft_act = document.querySelector("#ft"+indice).value;

                    let fd_act = new FormData();
                    console.log("indice: "+indice);
                    fd_act.append("new_activity","0");
                    fd_act.append("descripcion",description);
                    fd_act.append("fecha_inicio",fi_act);
                    fd_act.append("fecha_termino",ft_act);
                    fd_act.append("hoja_mantenimiento",support_sheet);

                    let req_act = new XMLHttpRequest();
                    req_act.onload = function(){
                        console.log("Recibi: "+req_act.responseText);
                        if(req_act.responseText == "error"){
                            error = true;
                        }
                    };

                    req_act.open("POST","http://localhost/QR_Directory/QR_Directory_API/api.php",true);
                    req_act.send(fd_act);

                    
                    
                    console.log("Descripcion: "+description);
                    console.log("Fecha inicio: "+fi_act);
                    console.log("Fecha termino: "+ft_act);
                    
                });

                if(error){
                    alert("Error");
                }

                else{
                    alert("Exito al crear");
                }
            };

            request_new_sheet.open("POST","http://localhost/QR_Directory/QR_Directory_API/api.php",true);
            request_new_sheet.send(fd_sheet);
        }

    </script>
</body>
</html>